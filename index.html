<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Princess Warrior Quest - Hard Mode</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow: hidden; background: #87CEEB; }
    canvas { display: block; margin: auto; background: linear-gradient(to top, #87CEEB, #ffffff); }
    .controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 20px; z-index: 100;
    }
    button {
      width: 60px; height: 60px;
      background: #ff99bb;
      border: none; border-radius: 50%;
      font-size: 24px; color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      user-select: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="900" height="450"></canvas>
  <div class="controls">
    <button id="left">⯇</button>
    <button id="jump">⭡</button>
    <button id="right">⯈</button>
  </div>
  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const princess = {
      x: 100, y: 300, width: 40, height: 60,
      color: '#ff69b4',
      vx: 0, vy: 0,
      speed: 4, jumpStrength: -13,
      onGround: false,
      facingRight: true,
    };

    const keys = { left: false, right: false, jump: false };
    const gravity = 0.6;
    let messageOpacity = 0;
    let sparkleParticles = [];
    let coinMessage = '';
    let coinMessageTimer = 0;

    // Longer platforms with more complexity + holes and trampolines
    const platforms = [
      { x: 0, y: 400, width: 500, height: 50 },     // start big ground
      { x: 520, y: 360, width: 120, height: 20 },
      { x: 700, y: 320, width: 100, height: 20 },
      { x: 850, y: 370, width: 150, height: 50 },   // big safe platform
      { x: 1050, y: 330, width: 100, height: 20 },
      { x: 1200, y: 300, width: 80, height: 20 },
      { x: 1300, y: 360, width: 150, height: 50 },
      { x: 1500, y: 280, width: 100, height: 20 },  // smaller platforms, harder jumps
      { x: 1650, y: 330, width: 120, height: 20 },
      { x: 1800, y: 370, width: 200, height: 50 },
      { x: 2050, y: 320, width: 100, height: 20 },
      { x: 2200, y: 280, width: 80, height: 20 },
      { x: 2300, y: 360, width: 150, height: 50 },
      { x: 2500, y: 400, width: 300, height: 50 },  // end large ground
    ];

    // Trampoline platform (bouncy)
    const trampolines = [
      { x: 1150, y: 310, width: 40, height: 10 }
    ];

    // Coins placed on tricky spots
    const coins = [
      { x: 540, y: 320, collected: false },
      { x: 720, y: 280, collected: false },
      { x: 1070, y: 290, collected: false },
      { x: 1230, y: 260, collected: false },
      { x: 1310, y: 320, collected: false },
      { x: 1510, y: 240, collected: false },
      { x: 1660, y: 290, collected: false },
      { x: 1820, y: 340, collected: false },
      { x: 2070, y: 290, collected: false },
      { x: 2210, y: 250, collected: false },
      { x: 2310, y: 320, collected: false },
      { x: 2550, y: 360, collected: false },
    ];

    // Moving enemies + spikes + flying birds
    const enemies = [
      // slow patrollers
      { x: 650, y: 340, width: 30, height: 30, vx: 1.5, color: '#e03c3c', type: 'patrol', range: [650, 770] },
      { x: 870, y: 350, width: 30, height: 30, vx: 2, color: '#e03c3c', type: 'patrol', range: [850, 1000] },
      { x: 1400, y: 340, width: 30, height: 30, vx: 2.5, color: '#e03c3c', type: 'patrol', range: [1300, 1450] },

      // spikes (stationary deadly obstacles)
      { x: 1100, y: 430, width: 30, height: 20, vx: 0, color: 'black', type: 'spike' },
      { x: 1900, y: 430, width: 30, height: 20, vx: 0, color: 'black', type: 'spike' },

      // flying birds, up and down movement
      { x: 900, y: 250, width: 40, height: 30, vx: 3, color: '#a020f0', type: 'bird', direction: 1, baseY: 250 },
      { x: 2000, y: 200, width: 40, height: 30, vx: 2, color: '#a020f0', type: 'bird', direction: -1, baseY: 200 },
    ];

    const flag = { x: 2700, y: 350, width: 30, height: 50, reached: false };

    // Draw the princess with eyes and magic trail
    function drawPrincess() {
      ctx.fillStyle = princess.color;
      ctx.fillRect(princess.x - cameraX, princess.y, princess.width, princess.height);

      // eyes
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      if (princess.facingRight) {
        ctx.arc(princess.x - cameraX + 10, princess.y + 20, 6, 0, Math.PI * 2);
        ctx.arc(princess.x - cameraX + 28, princess.y + 20, 6, 0, Math.PI * 2);
      } else {
        ctx.arc(princess.x - cameraX + princess.width - 10, princess.y + 20, 6, 0, Math.PI * 2);
        ctx.arc(princess.x - cameraX + princess.width - 28, princess.y + 20, 6, 0, Math.PI * 2);
      }
      ctx.fill();

      ctx.fillStyle = '#000';
      if (princess.facingRight) {
        ctx.beginPath();
        ctx.arc(princess.x - cameraX + 10, princess.y + 20, 3, 0, Math.PI * 2);
        ctx.arc(princess.x - cameraX + 28, princess.y + 20, 3, 0, Math.PI * 2);
      } else {
        ctx.beginPath();
        ctx.arc(princess.x - cameraX + princess.width - 10, princess.y + 20, 3, 0, Math.PI * 2);
        ctx.arc(princess.x - cameraX + princess.width - 28, princess.y + 20, 3, 0, Math.PI * 2);
      }
      ctx.fill();
    }

    function drawPlatforms() {
      ctx.fillStyle = '#228B22';
      platforms.forEach(p => {
        ctx.fillRect(p.x - cameraX, p.y, p.width, p.height);
      });
    }

    function drawTrampolines() {
      ctx.fillStyle = '#ff69b4';
      trampolines.forEach(t => {
        ctx.beginPath();
        ctx.ellipse(t.x - cameraX + t.width/2, t.y + t.height/2, t.width/2, t.height/2, 0, 0, Math.PI*2);
        ctx.fill();
      });
    }

    function drawCoins() {
      coins.forEach(c => {
        if (!c.collected) {
          ctx.beginPath();
          ctx.arc(c.x - cameraX, c.y, 10, 0, Math.PI * 2);
          ctx.fillStyle = 'gold';
          ctx.fill();
        }
      });
    }

    function drawEnemies() {
      enemies.forEach(e => {
        ctx.fillStyle = e.color;
        if(e.type === 'spike'){
          // spike shape
          ctx.beginPath();
          ctx.moveTo(e.x - cameraX, e.y + e.height);
          ctx.lineTo(e.x + e.width/2 - cameraX, e.y);
          ctx.lineTo(e.x + e.width - cameraX, e.y + e.height);
          ctx.closePath();
          ctx.fill();
        } else {
          ctx.fillRect(e.x - cameraX, e.y, e.width, e.height);
        }
      });
    }

    function drawFlag() {
      ctx.fillStyle = '#66ccff';
      ctx.fillRect(flag.x - cameraX, flag.y, flag.width, flag.height);
    }

    function showMessage() {
      if (messageOpacity < 1) messageOpacity += 0.01;
      ctx.globalAlpha = messageOpacity;

      // sparkles
      for (let i = 0; i < 150; i++) {
        ctx.fillStyle = `hsla(${Math.random()*360},100%,75%,0.6)`;
        ctx.beginPath();
        ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, 3, 0, Math.PI*2);
        ctx.fill();
      }

      ctx.fillStyle = '#ff69b4';
      ctx.font = '36px Comic Sans MS';
      ctx.textAlign = 'center';
      ctx.fillText('I love you baby', canvas.width / 2, canvas.height / 2);
      ctx.globalAlpha = 1;
    }

    function drawMagicTrail() {
      sparkleParticles.push({ x: princess.x + princess.width/2, y: princess.y + princess.height / 2, alpha: 1 });
      sparkleParticles.forEach(p => {
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = 'pink';
        ctx.beginPath();
        ctx.arc(p.x - cameraX, p.y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
        p.alpha -= 0.03;
      });
      sparkleParticles = sparkleParticles.filter(p => p.alpha > 0);
    }

    // Camera scrolls to follow princess but clamps at level edges
    let cameraX = 0;
    const levelWidth = 2800;

    function update() {
      if (!flag.reached) {
        if (keys.left) {
          princess.vx = -princess.speed;
          princess.facingRight = false;
        }
        else if (keys.right) {
          princess.vx = princess.speed;
          princess.facingRight = true;
        }
        else princess.vx = 0;

        if (keys.jump && princess.onGround) {
          princess.vy = princess.jumpStrength;
          princess.onGround = false;
        }

        princess.vy += gravity;
        princess.x += princess.vx;
        princess.y += princess.vy;

        princess.onGround = false;

        // Platform collision and ground check
        platforms.forEach(p => {
          if (
            princess.x + princess.width > p.x && princess.x < p.x + p.width &&
            princess.y + princess.height > p.y && princess.y + princess.height < p.y + p.height &&
            princess.vy >= 0
          ) {
            princess.y = p.y - princess.height;
            princess.vy = 0;
            princess.onGround = true;
          }
        });

        // Trampoline interaction: bounce higher
        trampolines.forEach(t => {
          if (
            princess.x + princess.width > t.x && princess.x < t.x + t.width &&
            princess.y + princess.height > t.y && princess.y + princess.height < t.y + t.height &&
            princess.vy >= 0
          ) {
            princess.vy = princess.jumpStrength * 1.8; // super jump
            princess.onGround = false;
          }
        });

        // Coin collection
        coins.forEach(c => {
          if (!c.collected &&
              princess.x < c.x + 10 && princess.x + princess.width > c.x - 10 &&
              princess.y < c.y + 10 && princess.y + princess.height > c.y - 10) {
            c.collected = true;
            coinMessage = "Yay! Coin! ✨";
            coinMessageTimer = 60;
          }
        });

        // Enemy behavior
        enemies.forEach(e => {
          if (e.type === 'patrol') {
            e.x += e.vx;
            if (e.x < e.range[0] || e.x > e.range[1]) e.vx *= -1;
          } else if (e.type === 'bird') {
            e.x += e.vx;
            // Fly back and forth horizontally
            if (e.x < 800 || e.x > levelWidth) e.vx *= -1;
            // Vertical bobbing
            e.y += 0.8 * e.direction;
            if (e.y > e.baseY + 30 || e.y < e.baseY - 30) e.direction *= -1;
          }

          // Collision with princess - reset position on hit
          if (
            princess.x < e.x + e.width && princess.x + princess.width > e.x &&
            princess.y < e.y + e.height && princess.y + princess.height > e.y
          ) {
            princess.x = 100;
            princess.y = 300;
            cameraX = 0;
          }
        });

        // Check if princess falls below the map (hole)
        if (princess.y > 600) {
          princess.x = 100;
          princess.y = 300;
          cameraX = 0;
        }

        // Check if reached flag
        if (
          princess.x + princess.width > flag.x && princess.x < flag.x + flag.width &&
          princess.y + princess.height > flag.y && princess.y < flag.y + flag.height
        ) {
          flag.reached = true;
        }

        // Clamp princess position so she doesn't go beyond level limits
        if (princess.x < 0) princess.x = 0;
        if (princess.x + princess.width > levelWidth) princess.x = levelWidth - princess.width;

        // Camera follows princess but clamps to level edges
        cameraX = princess.x - canvas.width / 3;
        if (cameraX < 0) cameraX = 0;
        if (cameraX > levelWidth - canvas.width) cameraX = levelWidth - canvas.width;
      }

      if (coinMessageTimer > 0) coinMessageTimer--;
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw blue sky & clouds (simple)
      ctx.fillStyle = '#87CEEB';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      for(let i=0; i<8; i++) {
        ctx.fillStyle = '#fff';
        ctx.beginPath();
        const cx = (i*150 - cameraX*0.5) % canvas.width;
        ctx.ellipse(cx, 80 + 10*Math.sin(i*2), 40, 25, 0, 0, 2*Math.PI);
        ctx.fill();
      }

      drawPlatforms();
      drawTrampolines();
      drawCoins();
      drawEnemies();
      drawFlag();
      drawMagicTrail();
      drawPrincess();

      if (flag.reached) showMessage();

      if (coinMessageTimer > 0) {
        ctx.fillStyle = '#fff';
        ctx.font = '20px Comic Sans MS';
        ctx.textAlign = 'center';
        ctx.fillText(coinMessage, princess.x - cameraX + 20, princess.y - 15);
      }
    }

    function gameLoop() {
      update();
      draw();
      requestAnimationFrame(gameLoop);
    }

    // Touch & mouse controls for mobile and desktop
    ['left', 'right', 'jump'].forEach(id => {
      const btn = document.getElementById(id);
      btn.addEventListener('touchstart', e => { keys[id] = true; e.preventDefault();
