<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Princess Warrior Quest - Multi-Level</title>
<style>
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    background: #a3d9ff;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  #gameCanvas {
    display: block;
    background: #9ee6ff;
    margin: 0 auto;
    touch-action: none;
    image-rendering: pixelated;
    border: 5px solid #f2c1d1;
    border-radius: 15px;
  }
  #ui {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 90vw;
    max-width: 500px;
    display: flex;
    justify-content: space-around;
    user-select: none;
  }
  button.control {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background: #ffb6c1;
    box-shadow: 0 4px 0 #d67a8e;
    font-size: 30px;
    color: white;
    font-weight: bold;
    user-select: none;
  }
  button.control:active {
    background: #ff84a0;
    box-shadow: 0 2px 0 #d67a8e;
    transform: translateY(2px);
  }
  #coinCounter {
    position: fixed;
    top: 10px;
    left: 10px;
    font-size: 1.5em;
    color: #ff6699;
    user-select: none;
  }
  #endScreen {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: #fce4eccc;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2.5em;
    font-weight: bold;
    color: #ff6699;
    text-align: center;
    visibility: hidden;
    flex-direction: column;
    padding: 20px;
  }
  #endScreen.animate {
    animation: fadein 2s ease forwards;
  }
  @keyframes fadein {
    0% {opacity: 0; transform: scale(0.7);}
    100% {opacity: 1; transform: scale(1);}
  }
</style>
</head>
<body>

<canvas id="gameCanvas" width="480" height="320"></canvas>

<div id="ui">
  <button id="leftBtn" class="control">â—€</button>
  <button id="jumpBtn" class="control">â–²</button>
  <button id="rightBtn" class="control">â–¶</button>
</div>

<div id="coinCounter">Coins: 0</div>

<div id="endScreen">I love you my pretty princess ðŸ’–</div>

<script>
(() => {
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const W = canvas.width;
  const H = canvas.height;

  // Scale canvas for mobile crispness
  const scale = window.devicePixelRatio || 1;
  canvas.style.width = W + 'px';
  canvas.style.height = H + 'px';
  canvas.width = W * scale;
  canvas.height = H * scale;
  ctx.scale(scale, scale);

  // Game variables
  let keys = { left: false, right: false, jump: false };
  let onGround = false;
  const gravity = 0.6;
  const friction = 0.7;

  // Player properties
  const player = {
    x: 50,
    y: H - 50,
    w: 32,
    h: 48,
    vx: 0,
    vy: 0,
    speed: 3,
    jumping: false,
    color: '#ff66aa',
  };

  // Coin count
  let totalCoins = 0;

  // Camera offset
  let camX = 0;

  // Level data - multiple levels with platforms, spikes, enemies, coins
  const levels = [
    {
      length: 1100,
      platforms: [
        {x: 0, y: H - 20, w: 1100, h: 20},
        {x: 200, y: H - 70, w: 60, h: 15},
        {x: 280, y: H - 120, w: 60, h: 15},
        {x: 400, y: H - 70, w: 60, h: 15},
        {x: 480, y: H - 150, w: 60, h: 15},
        {x: 600, y: H - 70, w: 60, h: 15},
        {x: 680, y: H - 120, w: 60, h: 15},
        {x: 800, y: H - 70, w: 60, h: 15},
        {x: 880, y: H - 150, w: 60, h: 15},
        {x: 950, y: H - 70, w: 60, h: 15},
      ],
      spikes: [
        {x: 350, y: H - 35, w: 20, h: 15},
        {x: 720, y: H - 35, w: 20, h: 15},
        {x: 920, y: H - 35, w: 20, h: 15},
      ],
      coins: [
        {x: 220, y: H - 100, w: 16, h: 16},
        {x: 300, y: H - 150, w: 16, h: 16},
        {x: 480, y: H - 180, w: 16, h: 16},
        {x: 600, y: H - 100, w: 16, h: 16},
        {x: 880, y: H - 180, w: 16, h: 16},
      ],
      enemies: [
        {x: 450, y: H - 35 - 32, w: 32, h: 32, vx: 1.5, range: [450, 510]},
        {x: 750, y: H - 35 - 32, w: 32, h: 32, vx: 2, range: [720, 780]},
      ],
    },
    {
      length: 1300,
      platforms: [
        {x: 0, y: H - 20, w: 1300, h: 20},
        {x: 150, y: H - 70, w: 80, h: 15},
        {x: 270, y: H - 120, w: 70, h: 15},
        {x: 400, y: H - 90, w: 50, h: 15},
        {x: 500, y: H - 140, w: 70, h: 15},
        {x: 620, y: H - 70, w: 80, h: 15},
        {x: 750, y: H - 120, w: 60, h: 15},
        {x: 880, y: H - 70, w: 60, h: 15},
        {x: 1000, y: H - 150, w: 60, h: 15},
        {x: 1100, y: H - 70, w: 100, h: 15},
      ],
      spikes: [
        {x: 350, y: H - 35, w: 20, h: 15},
        {x: 900, y: H - 35, w: 20, h: 15},
        {x: 1150, y: H - 35, w: 20, h: 15},
      ],
      coins: [
        {x: 170, y: H - 100, w: 16, h: 16},
        {x: 280, y: H - 150, w: 16, h: 16},
        {x: 510, y: H - 170, w: 16, h: 16},
        {x: 760, y: H - 150, w: 16, h: 16},
        {x: 1080, y: H - 100, w: 16, h: 16},
      ],
      enemies: [
        {x: 500, y: H - 35 - 32, w: 32, h: 32, vx: 1.8, range: [500, 570]},
        {x: 1000, y: H - 35 - 32, w: 32, h: 32, vx: 2.2, range: [1000, 1100]},
      ],
    }
  ];

  let currentLevelIndex = 0;
  let currentLevel = levels[currentLevelIndex];

  // Player respawn start position
  const startX = 50;
  const startY = H - 50;

  // UI coin counter
  const coinCounter = document.getElementById('coinCounter');

  // End screen element
  const endScreen = document.getElementById('endScreen');

  // Input handlers
  function keyDown(e) {
    if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
    if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
    if (e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') keys.jump = true;
  }
  function keyUp(e) {
    if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
    if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
    if (e.key === 'ArrowUp' || e.key === 'w' || e.key === ' ') keys.jump = false;
  }
  window.addEventListener('keydown', keyDown);
  window.addEventListener('keyup', keyUp);

  // Touch controls
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const jumpBtn = document.getElementById('jumpBtn');

  leftBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.left = true; });
  leftBtn.addEventListener('touchend', e => { e.preventDefault(); keys.left = false; });
  rightBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.right = true; });
  rightBtn.addEventListener('touchend', e => { e.preventDefault(); keys.right = false; });
  jumpBtn.addEventListener('touchstart', e => { e.preventDefault(); keys.jump = true; });
  jumpBtn.addEventListener('touchend', e => { e.preventDefault(); keys.jump = false; });

  // Collision detection helper
  function rectIntersect(r1, r2) {
    return !(r2.x > r1.x + r1.w || 
             r2.x + r2.w < r1.x || 
             r2.y > r1.y + r1.h ||
             r2.y + r2.h < r1.y);
  }

  // Reset player to start of current level
  function resetPlayer() {
    player.x = startX;
    player.y = startY;
    player.vx = 0;
    player.vy = 0;
    player.jumping = false;
  }

  // Handle enemy-player collisions
  function handleEnemyCollision(enemy, i) {
    if (rectIntersect(player, enemy)) {
      // Check if player hits enemy from top
      if (player.vy > 0 && (player.y + player.h) - enemy.y < 15) {
        // Enemy defeated
        currentLevel.enemies.splice(i, 1);
        player.vy = -10; // bounce up
      } else {
        // Player hurt - reset level
        resetPlayer();
      }
    }
  }

  // Handle coin collection
  function handleCoinCollection(coin, i) {
    if (rectIntersect(player, coin)) {
      // Remove coin
      currentLevel.coins.splice(i, 1);
      totalCoins++;
      coinCounter.textContent = `Coins: ${totalCoins}`;
    }
  }

  // Game end handler
  function endGame() {
    running = false;
    endScreen.style.visibility = 'visible';
    endScreen.classList.add('animate');
  }

  // Load next level or end game
  function nextLevel() {
    currentLevelIndex++;
    if (currentLevelIndex >= levels.length) {
      // All levels done!
      endGame();
    } else {
      currentLevel = levels[currentLevelIndex];
      resetPlayer();
      camX = 0;
      running = true;
      endScreen.style.visibility = 'hidden';
      endScreen.classList.remove('animate');
      loop();
    }
  }

  // Main update loop
  function update() {
    // Horizontal movement
    if (keys.left) {
      player.vx = -player.speed;
    } else if (keys
